<!DOCTYPE html>
<html lang="zh-CN" class="transition-colors duration-300">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevMemo - 玻璃拟态 & 暗黑模式</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%230071E3%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><ellipse cx=%2212%22 cy=%225%22 rx=%229%22 ry=%223%22></ellipse><path d=%22M21 12c0 1.66-4 3-9 3s-9-1.34-9-3%22></path><path d=%22M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5%22></path></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        ios: {
                            primary: '#0071E3',
                            danger: '#FF3B30',
                            success: '#34C759',
                            warning: '#FF9F0A',
                        }
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'SF Pro Text', 'Helvetica Neue', 'sans-serif'],
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.07)',
                        'glass-hover': '0 8px 32px 0 rgba(31, 38, 135, 0.15)',
                        'glow': '0 0 20px rgba(0, 113, 227, 0.3)',
                    },
                    animation: {
                        'blob': 'blob 7s infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { background-color: #F2F2F7; transition: background-color 0.3s ease; }
        html.dark body { background-color: #000000; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        html.dark .glass-panel {
            background: rgba(30, 30, 30, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        html.dark .glass-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }
        .glass-input:focus {
            background: rgba(255, 255, 255, 0.8);
            border-color: #0071E3;
            box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.15);
        }
        html.dark .glass-input:focus { background: rgba(0, 0, 0, 0.6); }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 10px; }
        html.dark ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.4); }

        .markdown-body { color: #1D1D1F; line-height: 1.6; }
        html.dark .markdown-body { color: #E5E5E5; }
        .markdown-body h1, .markdown-body h2 { color: #000; margin-top: 1em; margin-bottom: 0.5em; font-weight: 600; }
        html.dark .markdown-body h1, html.dark .markdown-body h2 { color: #FFF; }
        .markdown-body code { background: rgba(0,0,0,0.05); padding: 2px 5px; border-radius: 4px; font-family: monospace; color: #d63384; }
        html.dark .markdown-body code { background: rgba(255,255,255,0.1); color: #ff79c6; }
        .markdown-body pre { background: rgba(0,0,0,0.03); padding: 10px; border-radius: 8px; overflow-x: auto; }
        html.dark .markdown-body pre { background: rgba(0,0,0,0.3); }

        .fade-in { animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .scale-in { animation: scaleIn 0.25s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { 
            Plus, Search, Trash2, Edit2, CheckCircle, Clock, AlertCircle, 
            Code, Terminal, Save, X, Filter, LayoutGrid, List as ListIcon, 
            Bug, Lightbulb, Zap, Archive, Database, HelpCircle, Image as ImageIcon,
            Loader2, Upload, FileUp, AlignLeft, Calendar, Hash, AlertTriangle, Link as LinkIcon, Copy,
            CalendarDays, CalendarClock, Cpu, ShieldCheck, ChevronDown, Moon, Sun, Eye, Check, Layers
        } from 'https://esm.sh/lucide-react@0.263.1';

        const React = window.React;
        const useState = React.useState;
        const useEffect = React.useEffect;
        const useMemo = React.useMemo;
        const useRef = React.useRef;

        const SUPABASE_URL = 'https://lsggbiatbucdhhrgftra.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzZ2diaWF0YnVjZGhocmdmdHJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4OTA0NzIsImV4cCI6MjA3OTQ2NjQ3Mn0.GcAkpXZAETeSBSXoptYYmrlquwab0EapH7E8b5HCN7w';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const DEFAULT_USER = 'admin';
        const BUCKET_NAME = 'memo_images';

        const PRIORITY_LEVELS = {
            HIGH: { label: '紧急', color: 'bg-red-500/10 text-red-600 border-red-200 dark:text-red-400 dark:border-red-900' },
            MEDIUM: { label: '重要', color: 'bg-orange-500/10 text-orange-600 border-orange-200 dark:text-orange-400 dark:border-orange-900' },
            LOW: { label: '一般', color: 'bg-blue-500/10 text-blue-600 border-blue-200 dark:text-blue-400 dark:border-blue-900' },
        };

        const TYPES = {
            FEATURE: { label: '功能需求', icon: Lightbulb, color: 'text-purple-600 dark:text-purple-400 bg-purple-500/10' },
            BUG: { label: '缺陷修复', icon: Bug, color: 'text-red-600 dark:text-red-400 bg-red-500/10' },
            REFACTOR: { label: '代码重构', icon: Zap, color: 'text-orange-600 dark:text-orange-400 bg-orange-500/10' },
            DEBT: { label: '数据备忘', icon: Database, color: 'text-blue-600 dark:text-blue-400 bg-blue-500/10' },
        };

        const STATUSES = {
            TODO: { label: '待办', icon: Clock, color: 'bg-gray-500/10 text-gray-600 dark:text-gray-400' },
            IN_PROGRESS: { label: '进行中', icon: Code, color: 'bg-blue-500/10 text-blue-600 dark:text-blue-400' },
            TESTING: { label: '测试中', icon: Terminal, color: 'bg-purple-500/10 text-purple-600 dark:text-purple-400' },
            DONE: { label: '已完成', icon: CheckCircle, color: 'bg-green-500/10 text-green-600 dark:text-green-400' },
        };

        // --- Utils ---
        const parseImages = (imgData) => {
            if (!imgData) return [];
            // Try parsing JSON array
            try {
                const parsed = JSON.parse(imgData);
                if (Array.isArray(parsed)) return parsed;
                // If it's a valid JSON but not array, wrap it (rare case)
                return [imgData]; 
            } catch (e) {
                // Not JSON, treat as single URL string
                return [imgData];
            }
        };

        // --- Components ---

        const CustomSelect = ({ value, onChange, options, placeholder, icon: Icon, className = "" }) => {
            const [isOpen, setIsOpen] = useState(false);
            const containerRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (containerRef.current && !containerRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            const selectedOption = options.find(opt => opt.value === value);

            return (
                <div className={`relative ${className}`} ref={containerRef}>
                    <button 
                        type="button"
                        onClick={() => setIsOpen(!isOpen)}
                        className="glass-input w-full pl-4 pr-10 py-2.5 text-sm text-left flex items-center gap-2 rounded-xl transition-all shadow-sm focus:ring-4 focus:ring-[#0071E3]/10 h-full"
                    >
                        {Icon && <Icon className="h-4 w-4 text-gray-500 dark:text-gray-400" />}
                        {selectedOption && selectedOption.icon && (
                            <div className={`p-0.5 rounded ${selectedOption.color ? selectedOption.color.split(' ')[0] : ''}`}>
                                <selectedOption.icon className={`h-4 w-4 ${selectedOption.color ? selectedOption.color.split(' ')[0].replace('bg-', 'text-') : ''}`} />
                            </div>
                        )}
                        <span className={`block truncate flex-1 ${!selectedOption ? 'text-gray-400' : 'text-gray-900 dark:text-white'}`}>
                            {selectedOption ? selectedOption.label : placeholder}
                        </span>
                        <span className="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
                            <ChevronDown className={`h-4 w-4 text-gray-400 transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`} />
                        </span>
                    </button>

                    {isOpen && (
                        <div className="absolute z-50 mt-2 w-full min-w-[140px] rounded-2xl bg-white/90 dark:bg-gray-800/90 backdrop-blur-xl shadow-glass-hover ring-1 ring-black/5 dark:ring-white/10 focus:outline-none animate-in fade-in zoom-in-95 duration-150 origin-top">
                            <div className="py-1.5 max-h-60 overflow-auto custom-scrollbar px-1.5">
                                {options.map((option) => (
                                    <div
                                        key={option.value}
                                        onClick={() => { onChange(option.value); setIsOpen(false); }}
                                        className={`group flex items-center gap-2.5 px-3 py-2.5 text-sm cursor-pointer transition-all rounded-xl mb-0.5 ${option.value === value ? 'bg-[#0071E3]/10 text-[#0071E3] dark:text-blue-400 font-medium' : 'text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-white/10'}`}
                                    >
                                        {option.icon && (
                                            <div className={`p-1 rounded-md ${option.value === value ? 'bg-[#0071E3]/20' : 'bg-gray-100 dark:bg-gray-700 group-hover:bg-white dark:group-hover:bg-gray-600'}`}>
                                                <option.icon className={`h-4 w-4 ${option.color ? option.color.split(' ')[0].replace('bg-', 'text-') : 'text-gray-500'}`} />
                                            </div>
                                        )}
                                        <span className="flex-1 truncate">{option.label}</span>
                                        {option.value === value && <Check className="h-4 w-4 text-[#0071E3]" />}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const BackgroundDecorations = () => (
            <div className="fixed inset-0 -z-10 overflow-hidden pointer-events-none">
                <div className="absolute top-0 left-[-10%] w-[500px] h-[500px] bg-purple-300/30 rounded-full blur-[100px] mix-blend-multiply filter animate-blob opacity-70 dark:hidden"></div>
                <div className="absolute top-[20%] right-[-10%] w-[400px] h-[400px] bg-yellow-300/30 rounded-full blur-[100px] mix-blend-multiply filter animate-blob animation-delay-2000 opacity-70 dark:hidden"></div>
                <div className="absolute bottom-[-10%] left-[20%] w-[600px] h-[600px] bg-pink-300/30 rounded-full blur-[100px] mix-blend-multiply filter animate-blob animation-delay-4000 opacity-70 dark:hidden"></div>
                <div className="hidden dark:block absolute top-[-10%] left-[-10%] w-[600px] h-[600px] bg-blue-900/20 rounded-full blur-[120px] animate-blob"></div>
                <div className="hidden dark:block absolute bottom-0 right-0 w-[500px] h-[500px] bg-purple-900/20 rounded-full blur-[120px] animate-blob animation-delay-2000"></div>
            </div>
        );

        const Toast = ({ message, type, onClose }) => {
            useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, [onClose]);
            const iconColor = type === 'error' ? 'text-red-500' : 'text-green-500';
            return (
                <div className="fixed top-24 left-1/2 -translate-x-1/2 z-[100] glass-panel px-6 py-3 rounded-full shadow-glass-hover flex items-center gap-3 fade-in">
                    {type === 'error' ? <AlertTriangle className={`h-5 w-5 ${iconColor}`} /> : <CheckCircle className={`h-5 w-5 ${iconColor}`} />}
                    <span className="font-medium text-sm text-gray-800 dark:text-gray-100">{message}</span>
                </div>
            );
        };

        const ConfirmDialog = ({ isOpen, title, message, onConfirm, onCancel, isDangerous }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/20 backdrop-blur-md p-4 fade-in" onClick={onCancel}>
                    <div className="glass-panel bg-white/80 dark:bg-gray-900/80 rounded-2xl p-6 max-w-sm w-full shadow-2xl scale-in" onClick={e => e.stopPropagation()}>
                        <h3 className="text-xl font-semibold text-gray-900 dark:text-white mb-2">{title}</h3>
                        <p className="text-gray-500 dark:text-gray-400 text-sm mb-8 leading-relaxed">{message}</p>
                        <div className="flex justify-end gap-3">
                            <button onClick={onCancel} className="px-5 py-2.5 rounded-full text-gray-600 dark:text-gray-300 hover:bg-black/5 dark:hover:bg-white/10 transition-colors text-sm font-medium">取消</button>
                            <button onClick={onConfirm} className={`px-5 py-2.5 rounded-full text-white text-sm font-medium shadow-lg transition-transform active:scale-95 ${isDangerous ? 'bg-red-500 hover:bg-red-600' : 'bg-[#0071E3] hover:bg-[#0077ED]'}`}>确定</button>
                        </div>
                    </div>
                </div>
            );
        };

        const Loading = () => (
            <div className="flex h-screen items-center justify-center">
                <BackgroundDecorations />
                <div className="flex flex-col items-center gap-6 z-10">
                    <div className="h-12 w-12 animate-spin rounded-full border-4 border-white/30 border-t-[#0071E3]"></div>
                    <p className="text-gray-500 dark:text-gray-400 text-xs font-medium tracking-widest uppercase">Initializing...</p>
                </div>
            </div>
        );

        const GlassModal = ({ isOpen, onClose, title, children, maxWidth = "max-w-2xl" }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/20 backdrop-blur-md p-4 overflow-y-auto fade-in" onClick={onClose}>
                    <div className={`relative w-full ${maxWidth} glass-panel bg-white/80 dark:bg-gray-900/80 rounded-3xl shadow-2xl scale-in my-8`} onClick={e => e.stopPropagation()}>
                        <div className="flex items-center justify-between border-b border-gray-200/50 dark:border-white/10 p-5">
                            <h2 className="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">{title}</h2>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 text-gray-500 dark:text-gray-400 transition-colors"><X className="h-5 w-5" /></button>
                        </div>
                        <div className="p-6 md:p-8">{children}</div>
                    </div>
                </div>
            );
        };

        const Modal = (props) => <GlassModal {...props} />;

        const MarkdownContent = ({ content }) => {
            const htmlContent = useMemo(() => {
                if (!content) return '';
                try { return window.marked.parse(content, { breaks: true }); } catch (e) { return content; }
            }, [content]);
            return <div className="markdown-body" dangerouslySetInnerHTML={{ __html: htmlContent }} />;
        };

        const DueDateBadge = ({ date }) => {
            if (!date) return null;
            const targetDate = new Date(date);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            targetDate.setHours(0, 0, 0, 0);
            const diffTime = targetDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            let colorClass = "bg-gray-500/10 text-gray-600 dark:text-gray-400 border-gray-200 dark:border-gray-700"; 
            let text = targetDate.toLocaleDateString();
            if (diffDays < 0) { colorClass = "bg-red-500/10 text-red-600 dark:text-red-400 border-red-200 dark:border-red-900"; text = `逾期 ${Math.abs(diffDays)} 天`; }
            else if (diffDays === 0) { colorClass = "bg-orange-500/10 text-orange-600 dark:text-orange-400 border-orange-200 dark:border-orange-900"; text = "今天截止"; }
            else if (diffDays <= 3) { colorClass = "bg-blue-500/10 text-blue-600 dark:text-blue-400 border-blue-200 dark:border-blue-900"; text = `剩 ${diffDays} 天`; }
            return (<div className={`flex items-center gap-1.5 px-2.5 py-1 rounded-full border text-xs font-medium ${colorClass}`}><CalendarClock className="h-3.5 w-3.5" /><span>{text}</span></div>);
        };

        const DetailModal = ({ item, onClose, onImageClick }) => {
            if (!item) return null;
            const priorityStyle = PRIORITY_LEVELS[item.priority] || PRIORITY_LEVELS.LOW;
            const statusMeta = STATUSES[item.status] || STATUSES.TODO;
            const handleCopy = () => { navigator.clipboard.writeText(`# ${item.title}\n\n${item.description}`); };
            
            // Parse images
            const images = parseImages(item.image_url);

            return (
                <GlassModal isOpen={true} onClose={onClose} title="需求详情" maxWidth="max-w-5xl">
                    <div className="space-y-8 max-h-[75vh] overflow-y-auto custom-scrollbar px-1">
                        <div className="space-y-4">
                            <div className="flex items-start justify-between gap-4">
                                <h2 className="text-3xl font-bold text-gray-900 dark:text-white leading-tight">{item.title}</h2>
                                <button onClick={handleCopy} className="p-2 rounded-full text-gray-400 hover:bg-black/5 dark:hover:bg-white/10 hover:text-gray-900 dark:hover:text-white transition-colors flex-shrink-0"><Copy className="h-5 w-5" /></button>
                            </div>
                            <div className="flex flex-wrap items-center gap-3">
                                <div className={`flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium ${TYPES[item.type]?.color}`}>{TYPES[item.type]?.label}</div>
                                <div className={`flex items-center gap-1.5 px-3 py-1 rounded-full border text-xs font-medium ${priorityStyle.color}`}>{priorityStyle.label}</div>
                                <div className={`flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium ${statusMeta.color}`}>{statusMeta.label}</div>
                                {item.due_date && <DueDateBadge date={item.due_date} />}
                                <span className="text-gray-300 dark:text-gray-700 mx-1">|</span>
                                <span className="text-xs text-gray-400 dark:text-gray-500">ID: {item.id}</span>
                                <span className="text-xs text-gray-400 dark:text-gray-500">创建于 {item.created_at ? new Date(item.created_at).toLocaleDateString() : '未知'}</span>
                            </div>
                        </div>
                        <hr className="border-gray-100 dark:border-white/10" />
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div className="space-y-2 lg:col-span-2">
                                <h3 className="text-sm font-semibold text-gray-900 dark:text-gray-200 uppercase tracking-wider mb-3">详细描述</h3>
                                <div className="glass-input rounded-2xl p-6 min-h-[200px]">
                                    {item.description ? <MarkdownContent content={item.description} /> : <span className="text-gray-400 italic">暂无描述...</span>}
                                </div>
                            </div>
                            <div className="space-y-4 lg:col-span-1">
                                <h3 className="text-sm font-semibold text-gray-900 dark:text-gray-200 uppercase tracking-wider mb-3">附件 ({images.length})</h3>
                                {images.length > 0 ? (
                                    <div className="grid grid-cols-2 gap-2">
                                        {images.map((url, idx) => (
                                            <div 
                                                key={idx}
                                                className={`rounded-xl overflow-hidden border border-gray-200 dark:border-white/10 shadow-sm group cursor-zoom-in relative bg-gray-100 dark:bg-gray-800 ${images.length === 1 ? 'col-span-2 aspect-video' : 'aspect-square'}`}
                                                onClick={() => onImageClick(url)}
                                            >
                                                <img src={url} alt={`Attachment ${idx + 1}`} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                                                <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors flex items-center justify-center opacity-0 group-hover:opacity-100">
                                                    <Eye className="h-6 w-6 text-white drop-shadow-md" />
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="rounded-2xl border-2 border-dashed border-gray-200 dark:border-white/10 h-40 flex flex-col items-center justify-center text-gray-400 gap-2"><ImageIcon className="h-6 w-6 opacity-30" /><span className="text-xs">无图片附件</span></div>
                                )}
                            </div>
                        </div>
                    </div>
                </GlassModal>
            );
        };

        const ImagePreviewModal = ({ url, onClose }) => {
            if (!url) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/90 backdrop-blur-xl p-8 fade-in" onClick={onClose}>
                    <img src={url} alt="Preview" className="max-h-[90vh] max-w-full rounded-2xl shadow-2xl scale-in" onClick={(e) => e.stopPropagation()} />
                    <button className="absolute top-6 right-6 p-2 bg-white/10 text-white rounded-full hover:bg-white/20 transition-colors" onClick={onClose}><X className="h-6 w-6" /></button>
                </div>
            );
        };

        // --- Main Application ---
        function App() {
            const [isDark, setIsDark] = useState(() => {
                if (typeof window !== 'undefined') return localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
                return false;
            });
            useEffect(() => {
                const root = window.document.documentElement;
                if (isDark) { root.classList.add('dark'); localStorage.setItem('theme', 'dark'); } else { root.classList.remove('dark'); localStorage.setItem('theme', 'light'); }
            }, [isDark]);

            const [requirements, setRequirements] = useState([]);
            const [loading, setLoading] = useState(true);
            const [viewMode, setViewMode] = useState('grid');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [viewingItem, setViewingItem] = useState(null);
            const [editingId, setEditingId] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [filterType, setFilterType] = useState('ALL');
            const [filterStatus, setFilterStatus] = useState('ALL');
            const [previewImage, setPreviewImage] = useState(null);
            const [uploading, setUploading] = useState(false);
            const [isDragging, setIsDragging] = useState(false);
            // formData.images stores array of URLs
            const [formData, setFormData] = useState({ title: '', description: '', type: 'FEATURE', priority: 'MEDIUM', status: 'TODO', images: [], due_date: '' });
            const [toast, setToast] = useState(null);
            const [confirmDialog, setConfirmDialog] = useState({ isOpen: false, title: '', message: '', onConfirm: null, isDangerous: false });

            // Define options inside App component to ensure they are available in render scope
            const filterTypeOptions = useMemo(() => [
                { value: 'ALL', label: '类型: 全部' },
                ...Object.entries(TYPES).map(([key, val]) => ({ value: key, label: val.label, icon: val.icon, color: val.color }))
            ], []);

            const filterStatusOptions = useMemo(() => [
                { value: 'ALL', label: '状态: 全部' },
                ...Object.entries(STATUSES).map(([key, val]) => ({ value: key, label: val.label, icon: val.icon, color: val.color }))
            ], []);

            const formTypeOptions = useMemo(() => Object.entries(TYPES).map(([key, val]) => ({ value: key, label: val.label, icon: val.icon, color: val.color })), []);
            const formPriorityOptions = useMemo(() => Object.entries(PRIORITY_LEVELS).map(([key, val]) => ({ value: key, label: val.label, color: val.color })), []);

            const showToast = (message, type = 'success') => setToast({ message, type });
            const closeToast = () => setToast(null);
            const openConfirm = (title, message, onConfirm, isDangerous = false) => setConfirmDialog({ isOpen: true, title, message, onConfirm, isDangerous });
            const closeConfirm = () => setConfirmDialog(prev => ({ ...prev, isOpen: false }));

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.key === 'Escape') { if (isModalOpen) setIsModalOpen(false); if (viewingItem) setViewingItem(null); if (previewImage) setPreviewImage(null); }
                    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey) && isModalOpen) { const submitBtn = document.getElementById('modal-submit-btn'); if (submitBtn) submitBtn.click(); }
                };
                window.addEventListener('keydown', handleKeyDown); return () => window.removeEventListener('keydown', handleKeyDown);
            }, [isModalOpen, viewingItem, previewImage]);

            const fetchRequirements = async () => {
                try {
                    const { data, error } = await supabase.from('requirements').select('*').order('created_at', { ascending: false });
                    if (error) throw error;
                    setRequirements(data || []);
                    setLoading(false);
                } catch (error) { console.error("Fetch Error:", error); setLoading(false); }
            };
            useEffect(() => { fetchRequirements(); }, []);

            const deleteImageFromStorage = async (url) => {
                if (!url) return;
                try {
                    const bucketSegment = `/${BUCKET_NAME}/`;
                    const index = url.indexOf(bucketSegment);
                    if (index !== -1) {
                        let path = decodeURIComponent(url.substring(index + bucketSegment.length));
                        await supabase.storage.from(BUCKET_NAME).remove([path]);
                    }
                } catch (e) { console.error("Del Image Error:", e); }
            };

            const handleOpenModal = (req = null) => {
                setUploading(false);
                if (req) {
                    setEditingId(req.id);
                    setFormData({ 
                        title: req.title, 
                        description: req.description, 
                        type: req.type, 
                        priority: req.priority, 
                        status: req.status, 
                        images: parseImages(req.image_url), 
                        due_date: req.due_date ? req.due_date.split('T')[0] : '' 
                    });
                } else {
                    setEditingId(null);
                    setFormData({ title: '', description: '', type: 'FEATURE', priority: 'MEDIUM', status: 'TODO', images: [], due_date: '' });
                }
                setIsModalOpen(true);
            };

            const uploadFiles = async (files) => {
                setUploading(true);
                const newUrls = [];
                try {
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const fileExt = file.name.split('.').pop();
                        const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 5)}.${fileExt}`;
                        const filePath = `public/${fileName}`;
                        const { error } = await supabase.storage.from(BUCKET_NAME).upload(filePath, file);
                        if (error) throw error;
                        const { data } = supabase.storage.from(BUCKET_NAME).getPublicUrl(filePath);
                        newUrls.push(data.publicUrl);
                    }
                    
                    setFormData(prev => ({
                        ...prev,
                        images: [...prev.images, ...newUrls]
                    }));
                    showToast(`成功上传 ${files.length} 张图片`);
                } catch (error) { showToast(`上传失败: ${error.message}`, 'error'); } finally { setUploading(false); }
            };

            const handleFileChange = (e) => { 
                const files = e.target.files; 
                if (files && files.length > 0) { 
                    uploadFiles(files); 
                    e.target.value = ''; 
                } 
            };
            const handleDragOver = (e) => { e.preventDefault(); setIsDragging(true); };
            const handleDragLeave = (e) => { e.preventDefault(); setIsDragging(false); };
            const handleDrop = (e) => { 
                e.preventDefault(); 
                setIsDragging(false); 
                const files = e.dataTransfer.files; 
                if (files && files.length > 0) { 
                    uploadFiles(files); 
                } 
            };

            const handleRemoveImage = (index, e) => {
                e.preventDefault(); e.stopPropagation();
                openConfirm("移除图片", "确定要移除这张图片吗？这将删除已上传的文件。", () => {
                    const urlToDelete = formData.images[index];
                    const newImages = formData.images.filter((_, i) => i !== index);
                    
                    setFormData(prev => ({ ...prev, images: newImages }));
                    
                    // Background delete
                    deleteImageFromStorage(urlToDelete);
                    
                    closeConfirm();
                }, true);
            };

            const handleSubmit = async (e) => {
                if (e) e.preventDefault();
                // Store images array as JSON string in image_url field
                const imageJson = JSON.stringify(formData.images);
                
                const payload = { 
                    title: formData.title,
                    description: formData.description,
                    type: formData.type,
                    priority: formData.priority,
                    status: formData.status,
                    image_url: imageJson,
                    due_date: formData.due_date || null, 
                    updated_at: new Date().toISOString(), 
                    user_id: DEFAULT_USER 
                };
                
                try {
                    if (editingId) {
                        const { error } = await supabase.from('requirements').update(payload).eq('id', editingId);
                        if (error) throw error;
                        showToast("更新成功");
                    } else {
                        const { error } = await supabase.from('requirements').insert([{ ...payload, created_at: new Date().toISOString() }]);
                        if (error) throw error;
                        showToast("创建成功");
                    }
                    setIsModalOpen(false);
                    fetchRequirements();
                } catch (err) { showToast(`保存失败: ${err.message}`, 'error'); }
            };

            const handleDeleteTrigger = (req, e) => {
                if (e) e.stopPropagation();
                openConfirm("删除需求", "确定要删除这条需求吗？此操作无法撤销。", async () => {
                    try {
                        const images = parseImages(req.image_url);
                        // Delete all associated images
                        images.forEach(url => deleteImageFromStorage(url));
                        
                        const { error } = await supabase.from('requirements').delete().eq('id', req.id);
                        if (error) throw error;
                        showToast("删除成功");
                        fetchRequirements();
                    } catch (err) { showToast(`删除失败: ${err.message}`, 'error'); } finally { closeConfirm(); }
                }, true);
            };

            const quickUpdateStatus = async (id, currentStatus, e) => {
                if (e) e.stopPropagation();
                const cycle = ['TODO', 'IN_PROGRESS', 'TESTING', 'DONE'];
                const nextStatus = cycle[(cycle.indexOf(currentStatus) + 1) % cycle.length];
                try {
                    const { error } = await supabase.from('requirements').update({ status: nextStatus, updated_at: new Date().toISOString() }).eq('id', id);
                    if (error) throw error;
                    setRequirements(prev => prev.map(req => req.id === id ? { ...req, status: nextStatus } : req));
                    showToast(`状态更新: ${STATUSES[nextStatus].label}`);
                } catch (err) { console.error("Status Error:", err); }
            };

            const filteredRequirements = useMemo(() => requirements.filter(req => {
                const matchesSearch = (req.title || '').toLowerCase().includes(searchTerm.toLowerCase()) || (req.description || '').toLowerCase().includes(searchTerm.toLowerCase());
                const matchesType = filterType === 'ALL' || req.type === filterType;
                const matchesStatus = filterStatus === 'ALL' || req.status === filterStatus;
                return matchesSearch && matchesType && matchesStatus;
            }), [requirements, searchTerm, filterType, filterStatus]);

            if (loading) return <Loading />;

            return (
                <div className="min-h-screen pb-20 relative z-0">
                    <BackgroundDecorations />
                    {toast && <Toast message={toast.message} type={toast.type} onClose={closeToast} />}
                    <ConfirmDialog isOpen={confirmDialog.isOpen} title={confirmDialog.title} message={confirmDialog.message} onConfirm={confirmDialog.onConfirm} onCancel={closeConfirm} isDangerous={confirmDialog.isDangerous} />

                    {/* Navbar */}
                    <header className="sticky top-0 z-30 glass-panel border-b border-white/20 dark:border-white/5">
                        <div className="container mx-auto px-6 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="h-8 w-8 bg-[#0071E3] rounded-lg flex items-center justify-center text-white shadow-lg shadow-blue-500/30">
                                    <Database className="h-5 w-5" />
                                </div>
                                <h1 className="text-xl font-bold tracking-tight text-gray-900 dark:text-white">DevMemo</h1>
                            </div>
                            <div className="flex items-center gap-4">
                                <button onClick={() => setIsDark(!isDark)} className="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-black/5 dark:hover:bg-white/10 transition-colors">
                                    {isDark ? <Sun className="h-5 w-5" /> : <Moon className="h-5 w-5" />}
                                </button>
                                <button onClick={() => handleOpenModal()} className="bg-[#0071E3] hover:bg-[#0077ED] text-white px-5 py-2 rounded-full text-sm font-medium shadow-glow transition-all active:scale-95 flex items-center gap-2">
                                    <Plus className="h-4 w-4" /> 新建
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="container mx-auto px-6 py-8">
                        {/* Filters */}
                        <div className="mb-8 flex flex-col md:flex-row gap-4 items-center justify-between">
                            <div className="relative flex-1 w-full max-w-lg group">
                                <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400 group-focus-within:text-[#0071E3] transition-colors" />
                                <input 
                                    type="text" 
                                    placeholder="搜索需求..." 
                                    className="glass-input w-full rounded-xl py-2.5 pl-10 pr-4 text-sm text-gray-900 dark:text-white placeholder-gray-400 transition-all shadow-sm"
                                    value={searchTerm} 
                                    onChange={(e) => setSearchTerm(e.target.value)} 
                                />
                            </div>
                            <div className="flex items-center gap-3 w-full md:w-auto">
                                <div className="w-40">
                                    <CustomSelect 
                                        value={filterType} 
                                        onChange={setFilterType} 
                                        options={filterTypeOptions} 
                                        placeholder="类型"
                                    />
                                </div>
                                <div className="w-40">
                                    <CustomSelect 
                                        value={filterStatus} 
                                        onChange={setFilterStatus} 
                                        options={filterStatusOptions} 
                                        placeholder="状态"
                                    />
                                </div>
                                <div className="flex bg-gray-200/50 dark:bg-gray-800/50 p-1 rounded-lg h-[42px] items-center">
                                    <button onClick={() => setViewMode('grid')} className={`p-1.5 rounded-md transition-all ${viewMode === 'grid' ? 'bg-white dark:bg-gray-700 shadow-sm text-gray-900 dark:text-white' : 'text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'}`}><LayoutGrid className="h-4 w-4" /></button>
                                    <button onClick={() => setViewMode('list')} className={`p-1.5 rounded-md transition-all ${viewMode === 'list' ? 'bg-white dark:bg-gray-700 shadow-sm text-gray-900 dark:text-white' : 'text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'}`}><ListIcon className="h-4 w-4" /></button>
                                </div>
                            </div>
                        </div>

                        {/* Content Grid */}
                        {filteredRequirements.length === 0 ? (
                            <div className="flex flex-col items-center justify-center py-24 glass-panel rounded-3xl text-center">
                                <div className="bg-gray-50 dark:bg-gray-800 p-4 rounded-full mb-4">
                                    <Database className="h-8 w-8 text-gray-400 dark:text-gray-500" />
                                </div>
                                <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-1">暂无数据</h3>
                                <p className="text-gray-500 dark:text-gray-400 text-sm">点击右上角新建按钮开始记录</p>
                            </div>
                        ) : (
                            <div className={viewMode === 'grid' ? 'grid gap-6 sm:grid-cols-2 lg:grid-cols-3' : 'flex flex-col gap-4'}>
                                {filteredRequirements.map(req => {
                                    const TypeIcon = TYPES[req.type]?.icon || Lightbulb;
                                    const priorityStyle = PRIORITY_LEVELS[req.priority] || PRIORITY_LEVELS.LOW;
                                    const images = parseImages(req.image_url);
                                    
                                    return (
                                        <div 
                                            key={req.id} 
                                            onClick={() => setViewingItem(req)} 
                                            className={`glass-panel p-6 cursor-pointer group relative flex flex-col justify-between rounded-3xl shadow-glass hover:shadow-glass-hover hover:-translate-y-1 transition-all duration-300 ${viewMode === 'list' ? 'sm:flex-row sm:items-center sm:gap-8' : ''}`}
                                        >
                                            <div className={`flex-1 ${viewMode === 'list' ? 'min-w-0' : ''}`}>
                                                <div className="mb-4 flex items-center justify-between">
                                                    <div className="flex items-center gap-2">
                                                        <div className={`p-1.5 rounded-lg ${TYPES[req.type]?.color}`}>
                                                            <TypeIcon className="h-4 w-4" />
                                                        </div>
                                                        <span className={`px-2 py-0.5 rounded-md text-xs font-medium border ${priorityStyle.color}`}>
                                                            {priorityStyle.label}
                                                        </span>
                                                    </div>
                                                    <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                        <button onClick={(e) => { e.stopPropagation(); handleOpenModal(req); }} className="p-2 text-gray-400 dark:text-gray-500 hover:text-[#0071E3] dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded-full transition-colors"><Edit2 className="h-4 w-4" /></button>
                                                        <button onClick={(e) => handleDeleteTrigger(req, e)} className="p-2 text-gray-400 dark:text-gray-500 hover:text-red-500 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-full transition-colors"><Trash2 className="h-4 w-4" /></button>
                                                    </div>
                                                </div>
                                                
                                                <h3 className="mb-2 text-lg font-bold text-gray-900 dark:text-white truncate leading-tight">{req.title}</h3>
                                                
                                                <div className="space-y-4">
                                                    <p className={`text-sm text-gray-500 dark:text-gray-400 leading-relaxed ${viewMode === 'grid' ? 'line-clamp-2' : 'line-clamp-1'}`}>{req.description || <span className="text-gray-300 dark:text-gray-600 italic">无描述...</span>}</p>
                                                    
                                                    <div className="flex items-center gap-3">
                                                        <DueDateBadge date={req.due_date} />
                                                        {images.length > 0 && (
                                                            <div className="flex items-center gap-1 text-xs text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded-md">
                                                                <ImageIcon className="h-3 w-3" />
                                                                <span>{images.length > 1 ? `图片 +${images.length}` : '图片'}</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>

                                            <div className={`mt-5 pt-4 border-t border-gray-100 dark:border-white/10 flex items-center justify-between ${viewMode === 'list' ? 'mt-0 border-t-0 pt-0 sm:w-48 sm:flex-col sm:items-end sm:gap-3 border-l border-gray-100 dark:border-white/10 sm:pl-6' : ''}`}>
                                                <button onClick={(e) => quickUpdateStatus(req.id, req.status, e)} className="relative overflow-hidden rounded-full cursor-pointer active:scale-95 transition-transform">
                                                    <div className={`flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium ${STATUSES[req.status].color}`}>
                                                        <span className="w-1.5 h-1.5 rounded-full bg-current"></span>
                                                        {STATUSES[req.status].label}
                                                    </div>
                                                </button>
                                                <div className="text-xs text-gray-400 dark:text-gray-500 font-medium">{req.created_at ? new Date(req.created_at).toLocaleDateString() : 'N/A'}</div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </main>

                    {/* Modals */}
                    <DetailModal item={viewingItem} onClose={() => setViewingItem(null)} onImageClick={(url) => setPreviewImage(url)} />
                    <ImagePreviewModal url={previewImage} onClose={() => setPreviewImage(null)} />

                    {/* Add/Edit Modal */}
                    <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={editingId ? '编辑需求' : '新建需求'}>
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label className="mb-2 block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide">标题</label>
                                <input type="text" required className="glass-input w-full p-3 text-sm text-gray-900 dark:text-white placeholder-gray-400 rounded-xl" placeholder="请输入需求标题..." value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} />
                            </div>
                            <div className="grid grid-cols-2 gap-6">
                                <div>
                                    <label className="mb-2 block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide">类型</label>
                                    <CustomSelect 
                                        value={formData.type} 
                                        onChange={(val) => setFormData({...formData, type: val})} 
                                        options={formTypeOptions} 
                                        placeholder="选择类型"
                                    />
                                </div>
                                <div>
                                    <label className="mb-2 block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide">优先级</label>
                                    <CustomSelect 
                                        value={formData.priority} 
                                        onChange={(val) => setFormData({...formData, priority: val})} 
                                        options={formPriorityOptions} 
                                        placeholder="选择优先级"
                                    />
                                </div>
                            </div>
                            
                            <div>
                                <label className="mb-2 block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide">截止日期</label>
                                <div className="relative">
                                    <div className="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                        <CalendarClock className="w-4 h-4 text-gray-400" />
                                    </div>
                                    <input 
                                        type="date" 
                                        className="glass-input w-full pl-10 pr-3 py-2.5 text-sm text-gray-900 dark:text-white cursor-pointer rounded-xl"
                                        value={formData.due_date} 
                                        onChange={e => setFormData({...formData, due_date: e.target.value})} 
                                    />
                                </div>
                            </div>

                            <div>
                                <div className="flex items-center justify-between mb-2">
                                    <label className="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide">详细描述</label>
                                    <span className="text-[10px] text-gray-400">支持 Markdown</span>
                                </div>
                                <textarea rows={6} className="glass-input w-full p-3 text-sm text-gray-900 dark:text-white placeholder-gray-400 custom-scrollbar leading-relaxed rounded-xl" placeholder="输入需求详情..." value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})}></textarea>
                            </div>
                            
                            {/* Image Upload */}
                            <div>
                                <label className="mb-2 block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide">附件 ({formData.images.length})</label>
                                <div className="space-y-4">
                                    <div 
                                        className={`relative flex-1 group transition-all duration-200`}
                                        onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={handleDrop}
                                    >
                                        <input type="file" accept="image/*" multiple onChange={handleFileChange} disabled={uploading} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10 disabled:cursor-not-allowed" />
                                        <button type="button" className={`w-full flex flex-col items-center justify-center gap-2 rounded-xl border-2 border-dashed px-6 py-8 text-sm transition-colors h-32 ${isDragging ? 'border-[#0071E3] bg-blue-50 dark:bg-blue-900/20' : 'border-gray-200 dark:border-white/10 bg-gray-50 dark:bg-gray-800 text-gray-400 hover:border-gray-300 dark:hover:border-white/20 hover:bg-gray-100 dark:hover:bg-gray-700'} ${uploading ? 'opacity-50 cursor-not-allowed' : ''}`}>
                                            {uploading ? <Loader2 className="h-6 w-6 animate-spin text-[#0071E3]" /> : <div className={`p-3 rounded-full ${isDragging ? 'bg-blue-100 dark:bg-blue-900 text-[#0071E3]' : 'bg-white dark:bg-gray-700 shadow-sm text-gray-400'}`}><FileUp className="h-6 w-6" /></div>}
                                            <span className="text-xs font-medium">{uploading ? '上传中...' : '点击或拖入多张图片'}</span>
                                        </button>
                                    </div>

                                    {/* Uploaded Images List */}
                                    {formData.images.length > 0 && (
                                        <div className="grid grid-cols-3 sm:grid-cols-4 gap-3">
                                            {formData.images.map((url, idx) => (
                                                <div key={idx} className="relative aspect-square rounded-xl overflow-hidden border border-gray-200 dark:border-white/10 shadow-sm group">
                                                    <img src={url} alt={`Upload ${idx}`} className="w-full h-full object-cover" />
                                                    <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                                        <button 
                                                            type="button" 
                                                            onClick={(e) => handleRemoveImage(idx, e)}
                                                            className="p-2 rounded-full bg-red-500 text-white hover:bg-red-600 transition-colors shadow-lg"
                                                            title="移除图片"
                                                        >
                                                            <Trash2 className="h-4 w-4" />
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            <div className="pt-6 flex items-center justify-end gap-3 border-t border-gray-100 dark:border-white/10">
                                 <button type="button" onClick={() => setIsModalOpen(false)} className="px-6 py-2.5 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-white/10 transition-colors text-sm font-medium">取消</button>
                                 <button id="modal-submit-btn" type="submit" disabled={uploading} className="bg-[#0071E3] hover:bg-[#0077ED] text-white px-8 py-2.5 rounded-full text-sm font-medium shadow-glow transition-transform active:scale-95 disabled:opacity-50">
                                    保存
                                </button>
                            </div>
                        </form>
                    </Modal>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
